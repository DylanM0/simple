<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEIS API ë·°ì–´</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1200px;
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .card-header {
      background-color: #4a6baf;
      color: white;
      font-weight: bold;
      padding: 15px 20px;
    }
    .api-card {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .api-card:hover {
      transform: translateY(-5px);
    }
    .form-section {
      padding: 20px;
      background-color: #f1f3f9;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .result-section {
      max-height: 600px;
      overflow-y: auto;
    }
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }
    .result-json {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-results {
      position: absolute;
      z-index: 999;
      background: white;
      width: 100%;
      border: 1px solid #ced4da;
      border-radius: 0 0 5px 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background-color: #e9ecef;
    }
    .btn-primary {
      background-color: #4a6baf;
      border-color: #4a6baf;
    }
    .btn-primary:hover {
      background-color: #3a5a9f;
      border-color: #3a5a9f;
    }
    .tab-content {
      padding: 20px;
      background-color: white;
      border-radius: 0 0 10px 10px;
    }
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
    .result-actions {
      margin-bottom: 15px;
      display: flex;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">NEIS ì˜¤í”ˆ API ë·°ì–´</h1>
    
    <div class="card mb-4">
      <div class="card-header">
        API ì„ íƒ
      </div>
      <div class="card-body">
        <div class="row" id="apiTypeSelection">
          <!-- API ìœ í˜• ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <div class="card" id="formCard" style="display: none;">
      <div class="card-header">
        <span id="selectedApiName">API í¼</span>
      </div>
      <div class="card-body">
        <div class="form-section">
          <div class="mb-3">
            <label for="schoolName" class="form-label">í•™êµëª…</label>
            <div class="autocomplete-container">
              <input type="text" class="form-control" id="schoolName" placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ëŒ€ì§„ê³ ë“±í•™êµ)">
              <div class="autocomplete-results" id="schoolResults" style="display: none;"></div>
            </div>
          </div>
          
          <div class="mb-3" id="selectedSchoolInfo" style="display: none;">
            <div class="alert alert-info">
              <p class="mb-1"><strong>ì„ íƒëœ í•™êµ:</strong> <span id="displaySchoolName"></span></p>
              <p class="mb-1"><strong>êµìœ¡ì²­ ì½”ë“œ:</strong> <span id="displayOfficeCode"></span></p>
              <p class="mb-0"><strong>í•™êµ ì½”ë“œ:</strong> <span id="displaySchoolCode"></span></p>
            </div>
          </div>
          
          <div id="additionalParams">
            <!-- ì¶”ê°€ íŒŒë¼ë¯¸í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
          
          <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary" id="searchButton">ì¡°íšŒí•˜ê¸°</button>
          </div>
        </div>
        
        <div id="loadingSection" style="display: none;" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        
        <div id="resultSection" style="display: none;" class="result-section">
          <div class="result-actions">
            <button class="btn btn-success" id="excelDownloadBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-1" viewBox="0 0 16 16">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
              </svg>
              ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          <ul class="nav nav-tabs" id="resultTabs">
            <li class="nav-item">
              <a class="nav-link active" id="table-tab" data-bs-toggle="tab" href="#tableResult">í…Œì´ë¸” ë³´ê¸°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="json-tab" data-bs-toggle="tab" href="#jsonResult">JSON ë³´ê¸°</a>
            </li>
          </ul>
          <div class="tab-content mt-2">
            <div class="tab-pane fade show active" id="tableResult">
              <div class="table-responsive">
                <table class="table table-striped table-hover" id="resultTable">
                  <thead id="resultTableHead"></thead>
                  <tbody id="resultTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="jsonResult">
              <div class="result-json" id="resultJson"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script>
    // NEIS Open API ìƒìˆ˜
    const API_KEY = '247f27346637404cad8e1e2e8f49f9b2';
    const BASE_URL = 'https://open.neis.go.kr/hub/';

    // API ì¢…ë¥˜ ëª©ë¡
    const API_TYPES = [
      { id: 'schoolInfo', name: 'í•™êµ ê¸°ë³¸ ì •ë³´', icon: 'ğŸ«' },
      { id: 'mealServiceDietInfo', name: 'ê¸‰ì‹ ì •ë³´', icon: 'ğŸ±' },
      { id: 'hisTimetable', name: 'ì‹œê°„í‘œ ì •ë³´', icon: 'ğŸ“š' },
      { id: 'SchoolSchedule', name: 'í•™ì‚¬ ì¼ì •', icon: 'ğŸ“…' },
      { id: 'classInfo', name: 'ë°˜ ì •ë³´', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
      { id: 'schoolMajorinfo', name: 'í•™êµ ì „ê³µ ì •ë³´', icon: 'ğŸ“' },
      { id: 'schoolAflcoinfo', name: 'í•™êµ ê³„ì—´ ì •ë³´', icon: 'ğŸ”' },
      { id: 'tiClrminfo', name: 'ì‹œê°„í‘œ ê°•ì˜ì‹¤ ì •ë³´', icon: 'ğŸ¢' },
      { id: 'tiSubjectinfo', name: 'ê³¼ëª© ì •ë³´', icon: 'ğŸ“' }
    ];

    // êµìœ¡ì²­ ì½”ë“œ ëª©ë¡
    const OFFICE_CODES = [
      { code: 'B10', name: 'ì„œìš¸íŠ¹ë³„ì‹œêµìœ¡ì²­' },
      { code: 'C10', name: 'ë¶€ì‚°ê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'D10', name: 'ëŒ€êµ¬ê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'E10', name: 'ì¸ì²œê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'F10', name: 'ê´‘ì£¼ê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'G10', name: 'ëŒ€ì „ê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'H10', name: 'ìš¸ì‚°ê´‘ì—­ì‹œêµìœ¡ì²­' },
      { code: 'I10', name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œêµìœ¡ì²­' },
      { code: 'J10', name: 'ê²½ê¸°ë„êµìœ¡ì²­' },
      { code: 'K10', name: 'ê°•ì›íŠ¹ë³„ìì¹˜ë„êµìœ¡ì²­' },
      { code: 'M10', name: 'ì¶©ì²­ë¶ë„êµìœ¡ì²­' },
      { code: 'N10', name: 'ì¶©ì²­ë‚¨ë„êµìœ¡ì²­' },
      { code: 'P10', name: 'ì „ë¼ë¶ë„êµìœ¡ì²­' },
      { code: 'Q10', name: 'ì „ë¼ë‚¨ë„êµìœ¡ì²­' },
      { code: 'R10', name: 'ê²½ìƒë¶ë„êµìœ¡ì²­' },
      { code: 'S10', name: 'ê²½ìƒë‚¨ë„êµìœ¡ì²­' },
      { code: 'T10', name: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„êµìœ¡ì²­' }
    ];

    // í˜„ì¬ ì„ íƒëœ API ì •ë³´
    let currentApiType = null;
    let selectedSchool = null;

    // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      initializeApiTypes();
      setupEventListeners();
    });

    // API ìœ í˜• ì´ˆê¸°í™”
    function initializeApiTypes() {
      const apiTypeSelection = document.getElementById('apiTypeSelection');
      
      API_TYPES.forEach(api => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        
        col.innerHTML = `
          <div class="card api-card h-100" data-api-id="${api.id}">
            <div class="card-body">
              <h5 class="card-title">${api.icon} ${api.name}</h5>
              <p class="card-text text-muted">${api.id}</p>
            </div>
          </div>
        `;
        
        apiTypeSelection.appendChild(col);
      });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // API ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.api-card').forEach(card => {
        card.addEventListener('click', function() {
          const apiId = this.getAttribute('data-api-id');
          selectApiType(apiId);
        });
      });
      
      // í•™êµëª… ì…ë ¥ ì´ë²¤íŠ¸
      const schoolNameInput = document.getElementById('schoolName');
      schoolNameInput.addEventListener('input', debounce(searchSchools, 500));
      
      // í•™êµ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ í•­ëª© ì„ íƒ ì´ë²¤íŠ¸ëŠ” ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤
      
      // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById('searchButton').addEventListener('click', searchApi);
      
      // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById('excelDownloadBtn').addEventListener('click', downloadExcel);
    }

    // API ìœ í˜• ì„ íƒ
    function selectApiType(apiId) {
      currentApiType = API_TYPES.find(api => api.id === apiId);
      
      if (currentApiType) {
        document.getElementById('selectedApiName').textContent = currentApiType.name;
        document.getElementById('formCard').style.display = 'block';
        
        // ì¶”ê°€ íŒŒë¼ë¯¸í„° í•„ë“œ ìƒì„±
        generateAdditionalParams();
      }
    }

    // ì¶”ê°€ íŒŒë¼ë¯¸í„° í•„ë“œ ìƒì„±
    function generateAdditionalParams() {
      const additionalParams = document.getElementById('additionalParams');
      additionalParams.innerHTML = '';
      
      // API ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ ì¶”ê°€ íŒŒë¼ë¯¸í„° í‘œì‹œ
      if (['mealServiceDietInfo'].includes(currentApiType.id)) {
        // ë‚ ì§œ ê´€ë ¨ í•„ë“œ ì¶”ê°€
        const dateFieldsDiv = document.createElement('div');
        dateFieldsDiv.className = 'date-fields mt-3';
        
        dateFieldsDiv.innerHTML = `
          <h5>ë‚ ì§œ ì •ë³´</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="year" class="form-label">ë…„ë„</label>
              <input type="number" class="form-control" id="year" placeholder="YYYY" value="${new Date().getFullYear()}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="month" class="form-label">ì›”</label>
              <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${new Date().getMonth() + 1}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="day" class="form-label">ì¼</label>
              <input type="number" class="form-control" id="day" placeholder="DD" min="1" max="31" value="${new Date().getDate()}">
            </div>
          </div>
        `;
        
        additionalParams.appendChild(dateFieldsDiv);
      } 
      // ì‹œê°„í‘œ API - ê¸°ê°„ ì„¤ì • ì¶”ê°€
      else if (currentApiType.id === 'hisTimetable') {
        const timetableFieldsDiv = document.createElement('div');
        timetableFieldsDiv.className = 'timetable-fields mt-3';
        
        // ì˜¤ëŠ˜ ë‚ ì§œì™€ ì¼ì£¼ì¼ í›„ ë‚ ì§œ ê³„ì‚°
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const todayStr = today.toISOString().slice(0, 10);
        const nextWeekStr = nextWeek.toISOString().slice(0, 10);
        
        timetableFieldsDiv.innerHTML = `
          <h5>ê¸°ê°„ ì„¤ì •</h5>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="useTimetablePeriod">
            <label class="form-check-label" for="useTimetablePeriod">
              ê¸°ê°„ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°
            </label>
          </div>
          
          <div id="timetablePeriodFields" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="timetableFromDate" class="form-label">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="timetableFromDate" value="${todayStr}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="timetableToDate" class="form-label">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="timetableToDate" value="${nextWeekStr}">
              </div>
            </div>
          </div>
          
          <div id="timetableSingleDateFields">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="year" class="form-label">ë…„ë„</label>
                <input type="number" class="form-control" id="year" placeholder="YYYY" value="${today.getFullYear()}">
              </div>
              <div class="col-md-4 mb-3">
                <label for="month" class="form-label">ì›”</label>
                <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${today.getMonth() + 1}">
              </div>
              <div class="col-md-4 mb-3">
                <label for="day" class="form-label">ì¼</label>
                <input type="number" class="form-control" id="day" placeholder="DD" min="1" max="31" value="${today.getDate()}">
              </div>
            </div>
          </div>
          
          <h5 class="mt-3">í•™ë…„/ë°˜ ì •ë³´</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="grade" class="form-label">í•™ë…„</label>
              <select class="form-select" id="grade">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1í•™ë…„</option>
                <option value="2">2í•™ë…„</option>
                <option value="3">3í•™ë…„</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="classNum" class="form-label">ë°˜ (ì„ íƒì‚¬í•­)</label>
              <input type="number" class="form-control" id="classNum" placeholder="ë°˜ ë²ˆí˜¸">
            </div>
          </div>
        `;
        
        additionalParams.appendChild(timetableFieldsDiv);
        
        // ê¸°ê°„ ê²€ìƒ‰ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì •
        setTimeout(() => {
          const periodCheckbox = document.getElementById('useTimetablePeriod');
          const periodFields = document.getElementById('timetablePeriodFields');
          const singleDateFields = document.getElementById('timetableSingleDateFields');
          
          periodCheckbox.addEventListener('change', function() {
            if (this.checked) {
              periodFields.style.display = 'block';
              singleDateFields.style.display = 'none';
            } else {
              periodFields.style.display = 'none';
              singleDateFields.style.display = 'block';
            }
          });
        }, 100);
      }
      // í•™ì‚¬ì¼ì • API - ê¸°ê°„ ì„¤ì • ì¶”ê°€
      else if (currentApiType.id === 'SchoolSchedule') {
        const scheduleFieldsDiv = document.createElement('div');
        scheduleFieldsDiv.className = 'schedule-fields mt-3';
        
        // ì˜¤ëŠ˜ ë‚ ì§œì™€ í•œ ë‹¬ í›„ ë‚ ì§œ ê³„ì‚°
        const today = new Date();
        const nextMonth = new Date(today);
        nextMonth.setMonth(today.getMonth() + 1);
        
        const todayStr = today.toISOString().slice(0, 10);
        const nextMonthStr = nextMonth.toISOString().slice(0, 10);
        
        scheduleFieldsDiv.innerHTML = `
          <h5>ê¸°ê°„ ì„¤ì •</h5>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="useSchoolSchedulePeriod">
            <label class="form-check-label" for="useSchoolSchedulePeriod">
              ê¸°ê°„ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°
            </label>
          </div>
          
          <div id="periodSearchFields" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fromDate" class="form-label">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="fromDate" value="${todayStr}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="toDate" class="form-label">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="toDate" value="${nextMonthStr}">
              </div>
            </div>
          </div>
          
          <div id="monthSearchFields">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="year" class="form-label">ë…„ë„</label>
                <input type="number" class="form-control" id="year" placeholder="YYYY" value="${today.getFullYear()}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="month" class="form-label">ì›”</label>
                <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${today.getMonth() + 1}">
              </div>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(scheduleFieldsDiv);
        
        // ê¸°ê°„ ê²€ìƒ‰ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì •
        setTimeout(() => {
          const periodCheckbox = document.getElementById('useSchoolSchedulePeriod');
          const periodFields = document.getElementById('periodSearchFields');
          const monthFields = document.getElementById('monthSearchFields');
          
          periodCheckbox.addEventListener('change', function() {
            if (this.checked) {
              periodFields.style.display = 'block';
              monthFields.style.display = 'none';
            } else {
              periodFields.style.display = 'none';
              monthFields.style.display = 'block';
            }
          });
        }, 100);
      }
      // í•™êµê³„ì—´ì •ë³´ API - í•™ë…„ ì„ íƒ í•„ë“œ ì¶”ê°€
      else if (currentApiType.id === 'schoolAflcoinfo') {
        const aflcoFieldsDiv = document.createElement('div');
        aflcoFieldsDiv.className = 'aflco-fields mt-3';
        
        aflcoFieldsDiv.innerHTML = `
          <h5>í•™ë…„ ì •ë³´</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="aflcoGrade" class="form-label">í•™ë…„</label>
              <select class="form-select" id="aflcoGrade">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1í•™ë…„</option>
                <option value="2">2í•™ë…„</option>
                <option value="3">3í•™ë…„</option>
              </select>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(aflcoFieldsDiv);
      }
      // ê³¼ëª©ì •ë³´ API - í•™ë…„ ì„ íƒ í•„ë“œ ì¶”ê°€
      else if (currentApiType.id === 'tiSubjectinfo') {
        const subjectFieldsDiv = document.createElement('div');
        subjectFieldsDiv.className = 'subject-fields mt-3';
        
        subjectFieldsDiv.innerHTML = `
          <h5>í•™ë…„ ì •ë³´</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="subjectGrade" class="form-label">í•™ë…„</label>
              <select class="form-select" id="subjectGrade">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1í•™ë…„</option>
                <option value="2">2í•™ë…„</option>
                <option value="3">3í•™ë…„</option>
              </select>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(subjectFieldsDiv);
      }
    }

    // í•™êµ ê²€ìƒ‰
    async function searchSchools() {
      const schoolName = document.getElementById('schoolName').value.trim();
      const schoolResults = document.getElementById('schoolResults');
      
      if (schoolName.length < 2) {
        schoolResults.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`${BASE_URL}schoolInfo?Type=json&KEY=${API_KEY}&pIndex=1&pSize=5&SCHUL_NM=${encodeURIComponent(schoolName)}`);
        const data = await response.json();
        
        if (data.RESULT) {
          schoolResults.innerHTML = `<div class="autocomplete-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
        } else if (data.schoolInfo) {
          const schools = data.schoolInfo[1].row;
          
          schoolResults.innerHTML = '';
          schools.forEach(school => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = `${school.SCHUL_NM} <small class="text-muted">(${school.ATPT_OFCDC_SC_NM})</small>`;
            
            item.addEventListener('click', () => {
              selectSchool(school);
              schoolResults.style.display = 'none';
            });
            
            schoolResults.appendChild(item);
          });
        }
        
        schoolResults.style.display = 'block';
      } catch (error) {
        console.error('í•™êµ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        schoolResults.innerHTML = `<div class="autocomplete-item">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>`;
        schoolResults.style.display = 'block';
      }
    }

    // í•™êµ ì„ íƒ
    function selectSchool(school) {
      selectedSchool = school;
      
      document.getElementById('schoolName').value = school.SCHUL_NM;
      document.getElementById('displaySchoolName').textContent = school.SCHUL_NM;
      document.getElementById('displayOfficeCode').textContent = `${school.ATPT_OFCDC_SC_CODE} (${school.ATPT_OFCDC_SC_NM})`;
      document.getElementById('displaySchoolCode').textContent = school.SD_SCHUL_CODE;
      document.getElementById('selectedSchoolInfo').style.display = 'block';
    }

    // API ê²€ìƒ‰
    async function searchApi() {
      if (!currentApiType || !selectedSchool) {
        alert('API ìœ í˜•ê³¼ í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      document.getElementById('loadingSection').style.display = 'flex';
      document.getElementById('resultSection').style.display = 'none';
      
      try {
        // ê¸°ë³¸ íŒŒë¼ë¯¸í„° ì„¤ì •
        const params = {
          Type: 'json',
          KEY: API_KEY,
          pIndex: 1,
          pSize: 100,
          ATPT_OFCDC_SC_CODE: selectedSchool.ATPT_OFCDC_SC_CODE,
          SD_SCHUL_CODE: selectedSchool.SD_SCHUL_CODE
        };
        
        // API ìœ í˜•ì— ë”°ë¼ ì¶”ê°€ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
        if (['mealServiceDietInfo'].includes(currentApiType.id)) {
          const year = document.getElementById('year').value;
          const month = document.getElementById('month').value.padStart(2, '0');
          const day = document.getElementById('day').value.padStart(2, '0');
          params.MLSV_YMD = `${year}${month}${day}`;
        } else if (currentApiType.id === 'SchoolSchedule') {
          if (document.getElementById('useSchoolSchedulePeriod').checked) {
            // ê¸°ê°„ ê²€ìƒ‰ ì‚¬ìš©
            const fromDate = document.getElementById('fromDate').value.replace(/-/g, '');
            const toDate = document.getElementById('toDate').value.replace(/-/g, '');
            params.TI_FROM_YMD = fromDate;
            params.TI_TO_YMD = toDate;
          } else {
            // ë‹¨ì¼ ì›” ê²€ìƒ‰
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value.padStart(2, '0');
            params.AA_YMD = `${year}${month}`;
          }
        } else if (currentApiType.id === 'hisTimetable') {
          // í•™ë…„, ë°˜ ì •ë³´ ì¶”ê°€
          const grade = document.getElementById('grade').value;
          if (grade) params.GRADE = grade;
          
          const classNum = document.getElementById('classNum').value;
          if (classNum) params.CLASS_NM = classNum;
          
          if (document.getElementById('useTimetablePeriod') && document.getElementById('useTimetablePeriod').checked) {
            // ê¸°ê°„ ê²€ìƒ‰ ì‚¬ìš©
            const fromDate = document.getElementById('timetableFromDate').value.replace(/-/g, '');
            const toDate = document.getElementById('timetableToDate').value.replace(/-/g, '');
            params.TI_FROM_YMD = fromDate;
            params.TI_TO_YMD = toDate;
          } else {
            // ë‹¨ì¼ ë‚ ì§œ ê²€ìƒ‰
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value.padStart(2, '0');
            const day = document.getElementById('day').value.padStart(2, '0');
            params.ALL_TI_YMD = `${year}${month}${day}`;
          }
        } 
        // í•™êµê³„ì—´ì •ë³´ APIëŠ” í•™ë…„ ì •ë³´ê°€ í•„ìš”
        else if (currentApiType.id === 'schoolAflcoinfo') {
          const grade = document.getElementById('aflcoGrade').value;
          if (grade) params.GRADE = grade;
          
          // DGHT_CRSE_SC_NM ê°’ ì¶”ê°€ (ì£¼ê°„/ì•¼ê°„)
          params.DGHT_CRSE_SC_NM = 'ì£¼ê°„';
        }
        // ê³¼ëª©ì •ë³´ APIë„ í•™ë…„ ì •ë³´ê°€ í•„ìš”
        else if (currentApiType.id === 'tiSubjectinfo') {
          const grade = document.getElementById('subjectGrade').value;
          if (grade) params.GRADE = grade;
          // AY(í•™ë…„ë„), SEM(í•™ê¸°) ì¶”ê°€
          params.AY = new Date().getFullYear();
          params.SEM = (new Date().getMonth() >= 8 || new Date().getMonth() <= 1) ? '2' : '1';
        }
        
        // URL ì¿¼ë¦¬ ë¬¸ìì—´ êµ¬ì„±
        const queryString = Object.entries(params)
          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
          .join('&');
        
        // API ìš”ì²­ URL êµ¬ì„±
        const url = `${BASE_URL}${currentApiType.id}?${queryString}`;
        
        // API ìš”ì²­
        const response = await fetch(url);
        const data = await response.json();
        
        // ê²°ê³¼ í‘œì‹œ
        displayResults(data);
      } catch (error) {
        console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        document.getElementById('loadingSection').style.display = 'none';
      }
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(data) {
      const resultSection = document.getElementById('resultSection');
      const resultTableHead = document.getElementById('resultTableHead');
      const resultTableBody = document.getElementById('resultTableBody');
      const resultJson = document.getElementById('resultJson');
      
      // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥ (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©)
      window.currentApiData = data;
      
      // JSON ê²°ê³¼ í‘œì‹œ
      resultJson.textContent = JSON.stringify(data, null, 2);
      
      // í…Œì´ë¸” ê²°ê³¼ í‘œì‹œ
      resultTableHead.innerHTML = '';
      resultTableBody.innerHTML = '';
      
      // API ì‘ë‹µì—ì„œ ë°ì´í„° ì¶”ì¶œ
      let rows = [];
      
      if (data[currentApiType.id]) {
        // ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
        if (data.RESULT && data.RESULT.CODE !== 'INFO-000') {
          alert(`API ì˜¤ë¥˜: ${data.RESULT.MESSAGE}`);
          return;
        }
        
        // ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°
        rows = data[currentApiType.id][1].row;
        
        if (rows && rows.length > 0) {
          // í…Œì´ë¸” í—¤ë” ìƒì„±
          const headerRow = document.createElement('tr');
          
          Object.keys(rows[0]).forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
          });
          
          resultTableHead.appendChild(headerRow);
          
          // í…Œì´ë¸” ë³¸ë¬¸ ìƒì„±
          rows.forEach(row => {
            const tr = document.createElement('tr');
            
            Object.values(row).forEach(value => {
              const td = document.createElement('td');
              
              // HTML íƒœê·¸ê°€ í¬í•¨ëœ ê²½ìš° (ì˜ˆ: ê¸‰ì‹ ì •ë³´)
              if (typeof value === 'string' && value.includes('<br/>')) {
                td.innerHTML = value.replace(/<br\/>/g, '<br>');
              } else {
                td.textContent = value;
              }
              
              tr.appendChild(td);
            });
            
            resultTableBody.appendChild(tr);
          });
        } else {
          resultTableBody.innerHTML = '<tr><td colspan="100%" class="text-center">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        }
      } else if (data.RESULT) {
        // ì˜¤ë¥˜ ì‘ë‹µë§Œ ìˆëŠ” ê²½ìš°
        resultTableBody.innerHTML = `<tr><td colspan="100%" class="text-center">API ì˜¤ë¥˜: ${data.RESULT.MESSAGE}</td></tr>`;
      } else {
        // ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹
        resultTableBody.innerHTML = '<tr><td colspan="100%" class="text-center">ì‘ë‹µ ë°ì´í„° í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤</td></tr>';
      }
      
      resultSection.style.display = 'block';
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadExcel() {
      if (!window.currentApiData || !currentApiType) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // API ë°ì´í„° ì¶”ì¶œ
        let rows = [];
        
        if (window.currentApiData[currentApiType.id] && window.currentApiData[currentApiType.id][1].row) {
          rows = window.currentApiData[currentApiType.id][1].row;
        } else {
          alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // HTML íƒœê·¸ ì œê±°í•˜ëŠ” í•¨ìˆ˜
        function removeHtmlTags(text) {
          if (typeof text !== 'string') return text;
          return text.replace(/<\/?[^>]+(>|$)/g, ' ');
        }
        
        // ë°ì´í„° ê°€ê³µ - HTML íƒœê·¸ ì œê±°
        const cleanData = rows.map(row => {
          const cleanRow = {};
          Object.entries(row).forEach(([key, value]) => {
            cleanRow[key] = removeHtmlTags(value);
          });
          return cleanRow;
        });
        
        // ì›Œí¬ì‹œíŠ¸ ìƒì„±
        const worksheet = XLSX.utils.json_to_sheet(cleanData);
        
        // ì›Œí¬ë¶ ìƒì„± ë° ì›Œí¬ì‹œíŠ¸ ì¶”ê°€
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, currentApiType.name || 'Sheet1');
        
        // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const fileName = `NEIS_${currentApiType.id}_${dateStr}.xlsx`;
        
        // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        XLSX.writeFile(workbook, fileName);
        
      } catch (error) {
        console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë””ë°”ìš´ìŠ¤ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function debounce(func, delay) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }
  </script>
</body>
</html> 