<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEIS API Î∑∞Ïñ¥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1200px;
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .card-header {
      background-color: #4a6baf;
      color: white;
      font-weight: bold;
      padding: 15px 20px;
    }
    .api-card {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .api-card:hover {
      transform: translateY(-5px);
    }
    .form-section {
      padding: 20px;
      background-color: #f1f3f9;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .result-section {
      max-height: 600px;
      overflow-y: auto;
    }
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }
    .result-json {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-results {
      position: absolute;
      z-index: 999;
      background: white;
      width: 100%;
      border: 1px solid #ced4da;
      border-radius: 0 0 5px 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background-color: #e9ecef;
    }
    .btn-primary {
      background-color: #4a6baf;
      border-color: #4a6baf;
    }
    .btn-primary:hover {
      background-color: #3a5a9f;
      border-color: #3a5a9f;
    }
    .tab-content {
      padding: 20px;
      background-color: white;
      border-radius: 0 0 10px 10px;
    }
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
    .result-actions {
      margin-bottom: 15px;
      display: flex;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">NEIS Ïò§Ìîà API Î∑∞Ïñ¥</h1>
    
    <div class="card mb-4">
      <div class="card-header">
        API ÏÑ†ÌÉù
      </div>
      <div class="card-body">
        <div class="row" id="apiTypeSelection">
          <!-- API Ïú†Ìòï Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>
      </div>
    </div>

    <div class="card" id="formCard" style="display: none;">
      <div class="card-header">
        <span id="selectedApiName">API Ìèº</span>
      </div>
      <div class="card-body">
        <div class="form-section">
          <div class="mb-3">
            <label for="schoolName" class="form-label">ÌïôÍµêÎ™Ö</label>
            <div class="autocomplete-container">
              <input type="text" class="form-control" id="schoolName" placeholder="ÌïôÍµêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: ÎåÄÏßÑÍ≥†Îì±ÌïôÍµê)">
              <div class="autocomplete-results" id="schoolResults" style="display: none;"></div>
            </div>
          </div>
          
          <div class="mb-3" id="selectedSchoolInfo" style="display: none;">
            <div class="alert alert-info">
              <p class="mb-1"><strong>ÏÑ†ÌÉùÎêú ÌïôÍµê:</strong> <span id="displaySchoolName"></span></p>
              <p class="mb-1"><strong>ÍµêÏú°Ï≤≠ ÏΩîÎìú:</strong> <span id="displayOfficeCode"></span></p>
              <p class="mb-0"><strong>ÌïôÍµê ÏΩîÎìú:</strong> <span id="displaySchoolCode"></span></p>
            </div>
          </div>
          
          <div id="additionalParams">
            <!-- Ï∂îÍ∞Ä ÌååÎùºÎØ∏ÌÑ∞Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
          </div>
          
          <div class="d-grid gap-2 mt-4">
            <button class="btn btn-primary" id="searchButton">Ï°∞ÌöåÌïòÍ∏∞</button>
          </div>
        </div>
        
        <div id="loadingSection" style="display: none;" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        
        <div id="resultSection" style="display: none;" class="result-section">
          <div class="result-actions">
            <button class="btn btn-success" id="excelDownloadBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-1" viewBox="0 0 16 16">
                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
              </svg>
              ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            </button>
          </div>
          <ul class="nav nav-tabs" id="resultTabs">
            <li class="nav-item">
              <a class="nav-link active" id="table-tab" data-bs-toggle="tab" href="#tableResult">ÌÖåÏù¥Î∏î Î≥¥Í∏∞</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="json-tab" data-bs-toggle="tab" href="#jsonResult">JSON Î≥¥Í∏∞</a>
            </li>
          </ul>
          <div class="tab-content mt-2">
            <div class="tab-pane fade show active" id="tableResult">
              <div class="table-responsive">
                <table class="table table-striped table-hover" id="resultTable">
                  <thead id="resultTableHead"></thead>
                  <tbody id="resultTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="jsonResult">
              <div class="result-json" id="resultJson"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script>
    // NEIS Open API ÏÉÅÏàò
    const API_KEY = '247f27346637404cad8e1e2e8f49f9b2';
    const BASE_URL = 'https://open.neis.go.kr/hub/';

    // API Ï¢ÖÎ•ò Î™©Î°ù
    const API_TYPES = [
      { id: 'schoolInfo', name: 'ÌïôÍµê Í∏∞Î≥∏ Ï†ïÎ≥¥', icon: 'üè´' },
      { id: 'mealServiceDietInfo', name: 'Í∏âÏãù Ï†ïÎ≥¥', icon: 'üç±' },
      { id: 'hisTimetable', name: 'ÏãúÍ∞ÑÌëú Ï†ïÎ≥¥', icon: 'üìö' },
      { id: 'SchoolSchedule', name: 'ÌïôÏÇ¨ ÏùºÏ†ï', icon: 'üìÖ' },
      { id: 'classInfo', name: 'Î∞ò Ï†ïÎ≥¥', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
      { id: 'schoolMajorinfo', name: 'ÌïôÍµê Ï†ÑÍ≥µ Ï†ïÎ≥¥', icon: 'üéì' },
      { id: 'schoolAflcoinfo', name: 'ÌïôÍµê Í≥ÑÏó¥ Ï†ïÎ≥¥', icon: 'üîç' },
      { id: 'tiClrminfo', name: 'ÏãúÍ∞ÑÌëú Í∞ïÏùòÏã§ Ï†ïÎ≥¥', icon: 'üè¢' },
      { id: 'tiSubjectinfo', name: 'Í≥ºÎ™© Ï†ïÎ≥¥', icon: 'üìù' }
    ];

    // ÍµêÏú°Ï≤≠ ÏΩîÎìú Î™©Î°ù
    const OFFICE_CODES = [
      { code: 'B10', name: 'ÏÑúÏö∏ÌäπÎ≥ÑÏãúÍµêÏú°Ï≤≠' },
      { code: 'C10', name: 'Î∂ÄÏÇ∞Í¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'D10', name: 'ÎåÄÍµ¨Í¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'E10', name: 'Ïù∏Ï≤úÍ¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'F10', name: 'Í¥ëÏ£ºÍ¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'G10', name: 'ÎåÄÏ†ÑÍ¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'H10', name: 'Ïö∏ÏÇ∞Í¥ëÏó≠ÏãúÍµêÏú°Ï≤≠' },
      { code: 'I10', name: 'ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãúÍµêÏú°Ï≤≠' },
      { code: 'J10', name: 'Í≤ΩÍ∏∞ÎèÑÍµêÏú°Ï≤≠' },
      { code: 'K10', name: 'Í∞ïÏõêÌäπÎ≥ÑÏûêÏπòÎèÑÍµêÏú°Ï≤≠' },
      { code: 'M10', name: 'Ï∂©Ï≤≠Î∂ÅÎèÑÍµêÏú°Ï≤≠' },
      { code: 'N10', name: 'Ï∂©Ï≤≠ÎÇ®ÎèÑÍµêÏú°Ï≤≠' },
      { code: 'P10', name: 'Ï†ÑÎùºÎ∂ÅÎèÑÍµêÏú°Ï≤≠' },
      { code: 'Q10', name: 'Ï†ÑÎùºÎÇ®ÎèÑÍµêÏú°Ï≤≠' },
      { code: 'R10', name: 'Í≤ΩÏÉÅÎ∂ÅÎèÑÍµêÏú°Ï≤≠' },
      { code: 'S10', name: 'Í≤ΩÏÉÅÎÇ®ÎèÑÍµêÏú°Ï≤≠' },
      { code: 'T10', name: 'Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑÍµêÏú°Ï≤≠' }
    ];

    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú API Ï†ïÎ≥¥
    let currentApiType = null;
    let selectedSchool = null;

    // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ïã§Ìñâ
    document.addEventListener('DOMContentLoaded', function() {
      initializeApiTypes();
      setupEventListeners();
    });

    // API Ïú†Ìòï Ï¥àÍ∏∞Ìôî
    function initializeApiTypes() {
      const apiTypeSelection = document.getElementById('apiTypeSelection');
      
      API_TYPES.forEach(api => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        
        col.innerHTML = `
          <div class="card api-card h-100" data-api-id="${api.id}">
            <div class="card-body">
              <h5 class="card-title">${api.icon} ${api.name}</h5>
              <p class="card-text text-muted">${api.id}</p>
            </div>
          </div>
        `;
        
        apiTypeSelection.appendChild(col);
      });
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    function setupEventListeners() {
      // API Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      document.querySelectorAll('.api-card').forEach(card => {
        card.addEventListener('click', function() {
          const apiId = this.getAttribute('data-api-id');
          selectApiType(apiId);
        });
      });
      
      // ÌïôÍµêÎ™Ö ÏûÖÎ†• Ïù¥Î≤§Ìä∏
      const schoolNameInput = document.getElementById('schoolName');
      schoolNameInput.addEventListener('input', debounce(searchSchools, 500));
      
      // ÌïôÍµê Í≤ÄÏÉâ Í≤∞Í≥ºÏóêÏÑú Ìï≠Î™© ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏Îäî ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§
      
      // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      document.getElementById('searchButton').addEventListener('click', searchApi);
      
      // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      document.getElementById('excelDownloadBtn').addEventListener('click', downloadExcel);
    }

    // API Ïú†Ìòï ÏÑ†ÌÉù
    function selectApiType(apiId) {
      currentApiType = API_TYPES.find(api => api.id === apiId);
      
      if (currentApiType) {
        document.getElementById('selectedApiName').textContent = currentApiType.name;
        document.getElementById('formCard').style.display = 'block';
        
        // Ï∂îÍ∞Ä ÌååÎùºÎØ∏ÌÑ∞ ÌïÑÎìú ÏÉùÏÑ±
        generateAdditionalParams();
      }
    }

    // Ï∂îÍ∞Ä ÌååÎùºÎØ∏ÌÑ∞ ÌïÑÎìú ÏÉùÏÑ±
    function generateAdditionalParams() {
      const additionalParams = document.getElementById('additionalParams');
      additionalParams.innerHTML = '';
      
      // API Ïú†ÌòïÏóê Îî∞Îùº Îã§Î•∏ Ï∂îÍ∞Ä ÌååÎùºÎØ∏ÌÑ∞ ÌëúÏãú
      if (['mealServiceDietInfo'].includes(currentApiType.id)) {
        // ÎÇ†Ïßú Í¥ÄÎ†® ÌïÑÎìú Ï∂îÍ∞Ä
        const dateFieldsDiv = document.createElement('div');
        dateFieldsDiv.className = 'date-fields mt-3';
        
        dateFieldsDiv.innerHTML = `
          <h5>ÎÇ†Ïßú Ï†ïÎ≥¥</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="year" class="form-label">ÎÖÑÎèÑ</label>
              <input type="number" class="form-control" id="year" placeholder="YYYY" value="${new Date().getFullYear()}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="month" class="form-label">Ïõî</label>
              <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${new Date().getMonth() + 1}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="day" class="form-label">Ïùº</label>
              <input type="number" class="form-control" id="day" placeholder="DD" min="1" max="31" value="${new Date().getDate()}">
            </div>
          </div>
        `;
        
        additionalParams.appendChild(dateFieldsDiv);
      } 
      // ÏãúÍ∞ÑÌëú API - Í∏∞Í∞Ñ ÏÑ§Ï†ï Ï∂îÍ∞Ä
      else if (currentApiType.id === 'hisTimetable') {
        const timetableFieldsDiv = document.createElement('div');
        timetableFieldsDiv.className = 'timetable-fields mt-3';
        
        // Ïò§Îäò ÎÇ†ÏßúÏôÄ ÏùºÏ£ºÏùº ÌõÑ ÎÇ†Ïßú Í≥ÑÏÇ∞
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const todayStr = today.toISOString().slice(0, 10);
        const nextWeekStr = nextWeek.toISOString().slice(0, 10);
        
        timetableFieldsDiv.innerHTML = `
          <h5>Í∏∞Í∞Ñ ÏÑ§Ï†ï</h5>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="useTimetablePeriod">
            <label class="form-check-label" for="useTimetablePeriod">
              Í∏∞Í∞ÑÏúºÎ°ú Í≤ÄÏÉâÌïòÍ∏∞
            </label>
          </div>
          
          <div id="timetablePeriodFields" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="timetableFromDate" class="form-label">ÏãúÏûëÏùº</label>
                <input type="date" class="form-control" id="timetableFromDate" value="${todayStr}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="timetableToDate" class="form-label">Ï¢ÖÎ£åÏùº</label>
                <input type="date" class="form-control" id="timetableToDate" value="${nextWeekStr}">
              </div>
            </div>
          </div>
          
          <div id="timetableSingleDateFields">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="year" class="form-label">ÎÖÑÎèÑ</label>
                <input type="number" class="form-control" id="year" placeholder="YYYY" value="${today.getFullYear()}">
              </div>
              <div class="col-md-4 mb-3">
                <label for="month" class="form-label">Ïõî</label>
                <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${today.getMonth() + 1}">
              </div>
              <div class="col-md-4 mb-3">
                <label for="day" class="form-label">Ïùº</label>
                <input type="number" class="form-control" id="day" placeholder="DD" min="1" max="31" value="${today.getDate()}">
              </div>
            </div>
          </div>
          
          <h5 class="mt-3">ÌïôÎÖÑ/Î∞ò Ï†ïÎ≥¥</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="grade" class="form-label">ÌïôÎÖÑ</label>
              <select class="form-select" id="grade">
                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                <option value="1">1ÌïôÎÖÑ</option>
                <option value="2">2ÌïôÎÖÑ</option>
                <option value="3">3ÌïôÎÖÑ</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="classNum" class="form-label">Î∞ò (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
              <input type="number" class="form-control" id="classNum" placeholder="Î∞ò Î≤àÌò∏">
            </div>
          </div>
        `;
        
        additionalParams.appendChild(timetableFieldsDiv);
        
        // Í∏∞Í∞Ñ Í≤ÄÏÉâ Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setTimeout(() => {
          const periodCheckbox = document.getElementById('useTimetablePeriod');
          const periodFields = document.getElementById('timetablePeriodFields');
          const singleDateFields = document.getElementById('timetableSingleDateFields');
          
          periodCheckbox.addEventListener('change', function() {
            if (this.checked) {
              periodFields.style.display = 'block';
              singleDateFields.style.display = 'none';
            } else {
              periodFields.style.display = 'none';
              singleDateFields.style.display = 'block';
            }
          });
        }, 100);
      }
      // ÌïôÏÇ¨ÏùºÏ†ï API - Í∏∞Í∞Ñ ÏÑ§Ï†ï Ï∂îÍ∞Ä
      else if (currentApiType.id === 'SchoolSchedule') {
        const scheduleFieldsDiv = document.createElement('div');
        scheduleFieldsDiv.className = 'schedule-fields mt-3';
        
        // Ïò§Îäò ÎÇ†ÏßúÏôÄ Ìïú Îã¨ ÌõÑ ÎÇ†Ïßú Í≥ÑÏÇ∞
        const today = new Date();
        const nextMonth = new Date(today);
        nextMonth.setMonth(today.getMonth() + 1);
        
        const todayStr = today.toISOString().slice(0, 10);
        const nextMonthStr = nextMonth.toISOString().slice(0, 10);
        
        scheduleFieldsDiv.innerHTML = `
          <h5>Í∏∞Í∞Ñ ÏÑ§Ï†ï</h5>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="useSchoolSchedulePeriod">
            <label class="form-check-label" for="useSchoolSchedulePeriod">
              Í∏∞Í∞ÑÏúºÎ°ú Í≤ÄÏÉâÌïòÍ∏∞
            </label>
          </div>
          
          <div id="periodSearchFields" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fromDate" class="form-label">ÏãúÏûëÏùº</label>
                <input type="date" class="form-control" id="fromDate" value="${todayStr}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="toDate" class="form-label">Ï¢ÖÎ£åÏùº</label>
                <input type="date" class="form-control" id="toDate" value="${nextMonthStr}">
              </div>
            </div>
          </div>
          
          <div id="monthSearchFields">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="year" class="form-label">ÎÖÑÎèÑ</label>
                <input type="number" class="form-control" id="year" placeholder="YYYY" value="${today.getFullYear()}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="month" class="form-label">Ïõî</label>
                <input type="number" class="form-control" id="month" placeholder="MM" min="1" max="12" value="${today.getMonth() + 1}">
              </div>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(scheduleFieldsDiv);
        
        // Í∏∞Í∞Ñ Í≤ÄÏÉâ Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setTimeout(() => {
          const periodCheckbox = document.getElementById('useSchoolSchedulePeriod');
          const periodFields = document.getElementById('periodSearchFields');
          const monthFields = document.getElementById('monthSearchFields');
          
          periodCheckbox.addEventListener('change', function() {
            if (this.checked) {
              periodFields.style.display = 'block';
              monthFields.style.display = 'none';
            } else {
              periodFields.style.display = 'none';
              monthFields.style.display = 'block';
            }
          });
        }, 100);
      }
      // ÌïôÍµêÍ≥ÑÏó¥Ï†ïÎ≥¥ API - ÌïôÎÖÑ ÏÑ†ÌÉù ÌïÑÎìú Ï∂îÍ∞Ä
      else if (currentApiType.id === 'schoolAflcoinfo') {
        const aflcoFieldsDiv = document.createElement('div');
        aflcoFieldsDiv.className = 'aflco-fields mt-3';
        
        aflcoFieldsDiv.innerHTML = `
          <h5>ÌïôÎÖÑ Ï†ïÎ≥¥</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="aflcoGrade" class="form-label">ÌïôÎÖÑ</label>
              <select class="form-select" id="aflcoGrade">
                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                <option value="1">1ÌïôÎÖÑ</option>
                <option value="2">2ÌïôÎÖÑ</option>
                <option value="3">3ÌïôÎÖÑ</option>
              </select>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(aflcoFieldsDiv);
      }
      // Í≥ºÎ™©Ï†ïÎ≥¥ API - ÌïôÎÖÑ ÏÑ†ÌÉù ÌïÑÎìú Ï∂îÍ∞Ä
      else if (currentApiType.id === 'tiSubjectinfo') {
        const subjectFieldsDiv = document.createElement('div');
        subjectFieldsDiv.className = 'subject-fields mt-3';
        
        subjectFieldsDiv.innerHTML = `
          <h5>ÌïôÎÖÑ Ï†ïÎ≥¥</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="subjectGrade" class="form-label">ÌïôÎÖÑ</label>
              <select class="form-select" id="subjectGrade">
                <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                <option value="1">1ÌïôÎÖÑ</option>
                <option value="2">2ÌïôÎÖÑ</option>
                <option value="3">3ÌïôÎÖÑ</option>
              </select>
            </div>
          </div>
        `;
        
        additionalParams.appendChild(subjectFieldsDiv);
      }
    }

    // ÌïôÍµê Í≤ÄÏÉâ
    async function searchSchools() {
      const schoolName = document.getElementById('schoolName').value.trim();
      const schoolResults = document.getElementById('schoolResults');
      
      if (schoolName.length < 2) {
        schoolResults.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`${BASE_URL}schoolInfo?Type=json&KEY=${API_KEY}&pIndex=1&pSize=5&SCHUL_NM=${encodeURIComponent(schoolName)}`);
        const data = await response.json();
        
        if (data.RESULT) {
          schoolResults.innerHTML = `<div class="autocomplete-item">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>`;
        } else if (data.schoolInfo) {
          const schools = data.schoolInfo[1].row;
          
          schoolResults.innerHTML = '';
          schools.forEach(school => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.innerHTML = `${school.SCHUL_NM} <small class="text-muted">(${school.ATPT_OFCDC_SC_NM})</small>`;
            
            item.addEventListener('click', () => {
              selectSchool(school);
              schoolResults.style.display = 'none';
            });
            
            schoolResults.appendChild(item);
          });
        }
        
        schoolResults.style.display = 'block';
      } catch (error) {
        console.error('ÌïôÍµê Í≤ÄÏÉâ Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
        schoolResults.innerHTML = `<div class="autocomplete-item">Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</div>`;
        schoolResults.style.display = 'block';
      }
    }

    // ÌïôÍµê ÏÑ†ÌÉù
    function selectSchool(school) {
      selectedSchool = school;
      
      document.getElementById('schoolName').value = school.SCHUL_NM;
      document.getElementById('displaySchoolName').textContent = school.SCHUL_NM;
      document.getElementById('displayOfficeCode').textContent = `${school.ATPT_OFCDC_SC_CODE} (${school.ATPT_OFCDC_SC_NM})`;
      document.getElementById('displaySchoolCode').textContent = school.SD_SCHUL_CODE;
      document.getElementById('selectedSchoolInfo').style.display = 'block';
    }

    // API Í≤ÄÏÉâ
    async function searchApi() {
      if (!currentApiType || !selectedSchool) {
        alert('API Ïú†ÌòïÍ≥º ÌïôÍµêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }
      
      // Î°úÎî© ÌëúÏãú
      document.getElementById('loadingSection').style.display = 'flex';
      document.getElementById('resultSection').style.display = 'none';
      
      try {
        // Í∏∞Î≥∏ ÌååÎùºÎØ∏ÌÑ∞ ÏÑ§Ï†ï
        const params = {
          Type: 'json',
          KEY: API_KEY,
          pIndex: 1,
          pSize: 100,
          ATPT_OFCDC_SC_CODE: selectedSchool.ATPT_OFCDC_SC_CODE,
          SD_SCHUL_CODE: selectedSchool.SD_SCHUL_CODE
        };
        
        // API Ïú†ÌòïÏóê Îî∞Îùº Ï∂îÍ∞Ä ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë
        if (['mealServiceDietInfo'].includes(currentApiType.id)) {
          const year = document.getElementById('year').value;
          const month = document.getElementById('month').value.padStart(2, '0');
          const day = document.getElementById('day').value.padStart(2, '0');
          params.MLSV_YMD = `${year}${month}${day}`;
        } else if (currentApiType.id === 'SchoolSchedule') {
          if (document.getElementById('useSchoolSchedulePeriod').checked) {
            // Í∏∞Í∞Ñ Í≤ÄÏÉâ ÏÇ¨Ïö©
            const fromDate = document.getElementById('fromDate').value.replace(/-/g, '');
            const toDate = document.getElementById('toDate').value.replace(/-/g, '');
            params.TI_FROM_YMD = fromDate;
            params.TI_TO_YMD = toDate;
          } else {
            // Îã®Ïùº Ïõî Í≤ÄÏÉâ
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value.padStart(2, '0');
            params.AA_YMD = `${year}${month}`;
          }
        } else if (currentApiType.id === 'hisTimetable') {
          // ÌïôÎÖÑ, Î∞ò Ï†ïÎ≥¥ Ï∂îÍ∞Ä
          const grade = document.getElementById('grade').value;
          if (grade) params.GRADE = grade;
          
          const classNum = document.getElementById('classNum').value;
          if (classNum) params.CLASS_NM = classNum;
          
          if (document.getElementById('useTimetablePeriod') && document.getElementById('useTimetablePeriod').checked) {
            // Í∏∞Í∞Ñ Í≤ÄÏÉâ ÏÇ¨Ïö©
            const fromDate = document.getElementById('timetableFromDate').value.replace(/-/g, '');
            const toDate = document.getElementById('timetableToDate').value.replace(/-/g, '');
            params.TI_FROM_YMD = fromDate;
            params.TI_TO_YMD = toDate;
          } else {
            // Îã®Ïùº ÎÇ†Ïßú Í≤ÄÏÉâ
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value.padStart(2, '0');
            const day = document.getElementById('day').value.padStart(2, '0');
            params.ALL_TI_YMD = `${year}${month}${day}`;
          }
        } 
        // ÌïôÍµêÍ≥ÑÏó¥Ï†ïÎ≥¥ APIÎäî ÌïôÎÖÑ Ï†ïÎ≥¥Í∞Ä ÌïÑÏöî
        else if (currentApiType.id === 'schoolAflcoinfo') {
          const grade = document.getElementById('aflcoGrade').value;
          if (grade) params.GRADE = grade;
          
          // DGHT_CRSE_SC_NM Í∞í Ï∂îÍ∞Ä (Ï£ºÍ∞Ñ/ÏïºÍ∞Ñ)
          params.DGHT_CRSE_SC_NM = 'Ï£ºÍ∞Ñ';
        }
        // Í≥ºÎ™©Ï†ïÎ≥¥ APIÎèÑ ÌïôÎÖÑ Ï†ïÎ≥¥Í∞Ä ÌïÑÏöî
        else if (currentApiType.id === 'tiSubjectinfo') {
          const grade = document.getElementById('subjectGrade').value;
          if (grade) params.GRADE = grade;
          // AY(ÌïôÎÖÑÎèÑ), SEM(ÌïôÍ∏∞) Ï∂îÍ∞Ä
          params.AY = new Date().getFullYear();
          params.SEM = (new Date().getMonth() >= 8 || new Date().getMonth() <= 1) ? '2' : '1';
        }
        
        // URL ÏøºÎ¶¨ Î¨∏ÏûêÏó¥ Íµ¨ÏÑ±
        const queryString = Object.entries(params)
          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
          .join('&');
        
        // API ÏöîÏ≤≠ URL Íµ¨ÏÑ±
        const url = `${BASE_URL}${currentApiType.id}?${queryString}`;
        
        // API ÏöîÏ≤≠
        const response = await fetch(url);
        const data = await response.json();
        
        // Í≤∞Í≥º ÌëúÏãú
        displayResults(data);
      } catch (error) {
        console.error('API Ìò∏Ï∂ú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
        alert('API Ìò∏Ï∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏΩòÏÜîÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
      } finally {
        document.getElementById('loadingSection').style.display = 'none';
      }
    }

    // Í≤∞Í≥º ÌëúÏãú
    function displayResults(data) {
      const resultSection = document.getElementById('resultSection');
      const resultTableHead = document.getElementById('resultTableHead');
      const resultTableBody = document.getElementById('resultTableBody');
      const resultJson = document.getElementById('resultJson');
      
      // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏóëÏÖÄ Îã§Ïö¥Î°úÎìúÏö©)
      window.currentApiData = data;
      
      // JSON Í≤∞Í≥º ÌëúÏãú
      resultJson.textContent = JSON.stringify(data, null, 2);
      
      // ÌÖåÏù¥Î∏î Í≤∞Í≥º ÌëúÏãú
      resultTableHead.innerHTML = '';
      resultTableBody.innerHTML = '';
      
      // API ÏùëÎãµÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
      let rows = [];
      
      if (data[currentApiType.id]) {
        // Ïò§Î•ò ÏùëÎãµ Ï≤òÎ¶¨
        if (data.RESULT && data.RESULT.CODE !== 'INFO-000') {
          alert(`API Ïò§Î•ò: ${data.RESULT.MESSAGE}`);
          return;
        }
        
        // Í≤∞Í≥ºÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
        rows = data[currentApiType.id][1].row;
        
        if (rows && rows.length > 0) {
          // ÌÖåÏù¥Î∏î Ìó§Îçî ÏÉùÏÑ±
          const headerRow = document.createElement('tr');
          
          Object.keys(rows[0]).forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
          });
          
          resultTableHead.appendChild(headerRow);
          
          // ÌÖåÏù¥Î∏î Î≥∏Î¨∏ ÏÉùÏÑ±
          rows.forEach(row => {
            const tr = document.createElement('tr');
            
            Object.values(row).forEach(value => {
              const td = document.createElement('td');
              
              // HTML ÌÉúÍ∑∏Í∞Ä Ìè¨Ìï®Îêú Í≤ΩÏö∞ (Ïòà: Í∏âÏãù Ï†ïÎ≥¥)
              if (typeof value === 'string' && value.includes('<br/>')) {
                td.innerHTML = value.replace(/<br\/>/g, '<br>');
              } else {
                td.textContent = value;
              }
              
              tr.appendChild(td);
            });
            
            resultTableBody.appendChild(tr);
          });
        } else {
          resultTableBody.innerHTML = '<tr><td colspan="100%" class="text-center">Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</td></tr>';
        }
      } else if (data.RESULT) {
        // Ïò§Î•ò ÏùëÎãµÎßå ÏûàÎäî Í≤ΩÏö∞
        resultTableBody.innerHTML = `<tr><td colspan="100%" class="text-center">API Ïò§Î•ò: ${data.RESULT.MESSAGE}</td></tr>`;
      } else {
        // ÏòàÏÉÅÏπò Î™ªÌïú ÏùëÎãµ ÌòïÏãù
        resultTableBody.innerHTML = '<tr><td colspan="100%" class="text-center">ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ ÏòàÏÉÅÍ≥º Îã§Î¶ÖÎãàÎã§</td></tr>';
      }
      
      resultSection.style.display = 'block';
    }

    // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ìï®Ïàò
    function downloadExcel() {
      if (!window.currentApiData || !currentApiType) {
        alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }
      
      try {
        // API Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
        let rows = [];
        
        if (window.currentApiData[currentApiType.id] && window.currentApiData[currentApiType.id][1].row) {
          rows = window.currentApiData[currentApiType.id][1].row;
        } else {
          alert('Îã§Ïö¥Î°úÎìúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }
        
        // HTML ÌÉúÍ∑∏ Ï†úÍ±∞ÌïòÎäî Ìï®Ïàò
        function removeHtmlTags(text) {
          if (typeof text !== 'string') return text;
          return text.replace(/<\/?[^>]+(>|$)/g, ' ');
        }
        
        // Îç∞Ïù¥ÌÑ∞ Í∞ÄÍ≥µ - HTML ÌÉúÍ∑∏ Ï†úÍ±∞
        const cleanData = rows.map(row => {
          const cleanRow = {};
          Object.entries(row).forEach(([key, value]) => {
            cleanRow[key] = removeHtmlTags(value);
          });
          return cleanRow;
        });
        
        // ÏõåÌÅ¨ÏãúÌä∏ ÏÉùÏÑ±
        const worksheet = XLSX.utils.json_to_sheet(cleanData);
        
        // ÏõåÌÅ¨Î∂Å ÏÉùÏÑ± Î∞è ÏõåÌÅ¨ÏãúÌä∏ Ï∂îÍ∞Ä
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, currentApiType.name || 'Sheet1');
        
        // ÌååÏùºÎ™Ö ÏÉùÏÑ± (ÌòÑÏû¨ ÎÇ†Ïßú Ìè¨Ìï®)
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const fileName = `NEIS_${currentApiType.id}_${dateStr}.xlsx`;
        
        // ÏóëÏÖÄ ÌååÏùº Îã§Ïö¥Î°úÎìú
        XLSX.writeFile(workbook, fileName);
        
      } catch (error) {
        console.error('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
        alert('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }

    // ÎîîÎ∞îÏö¥Ïä§ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
    function debounce(func, delay) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }
  </script>
</body>
</html> 